==== Neo4j MqTT Cypher Client
MqTT publish subscribe from Neo4j 

[NOTE]
====
 based on org.eclipse.paho.client.mqttv3 library 
 tested with Eclipse Mosquitto 1.5.8 MqTT broker
====

Managing MqTT brokers
[source,cypher]
----
// --- Register MqTT Broker ---
// all values under connect options are optional - default values are shown
RETURN apoc.mqtt.addBroker(
 'mqttBrokerId', 
 {
    serverURI:'tcp://localhost:1883',
    clientId:'mqttBrokerId'+'Client'+random,
    qos:0, 
    automaticReconnect:true, 
    cleanSession:false, 
    connectionTimeout:1  
 }
)

// --- List MqTT Brokers ---
// basic statistics are shown
RETURN apoc.mqtt.listBrokers()

// --- List MqTT Brokers vNode returned ---
// basic statistics are shown
RETURN apoc.mqtt.listBrokersAsVnode()

// --- Remove MqTT Broker ---
RETURN apoc.mqtt.deleteBroker('mqttBrokerLocalhost')
----


MqTT publish
[source,cypher]
----
// --- Publish MqTT message ---
RETURN apoc.mqtt.publish(
    'mqttBrokerId', 
    'mqtt/topic/path', 
    {mqttMessageValue:"message as json or value"}, 
    {options:"options - currently not used"}
)
----

MqTT subscribe
[source,cypher]
----
// --- Subscribe to MqTT Topic Procedure ---
CALL apoc.mqtt.subscribe(
    'mqttBrokerId', 
    'mqtt/topic/path',
    'MERGE (n:CypherMqttCreated) 
        ON CREATE SET n.count=1, n.mqttMessageValue=$mqttMessageValue 
        ON MATCH SET n.count = n.count +1, n.mqttMessageValue=$mqttMessageValue 
     RETURN n', 
    {messageType:'json'}
 )

// --- List Subscriptions ---
// basic subscription statistics are shown
RETURN apoc.mqtt.listSubscriptions('optionalBrokerIdDefaultToAll')

// --- List Subscriptions vNode Returned ---
// basic subscription statistics are shown
RETURN apoc.mqtt.listSubscriptionsAsVnode('optionalBrokerIdDefaultToAll')

// --- Remove MqTT subscription ---
RETURN apoc.mqtt.unSubscribe('mqttBrokerId', '/mqtt/topic/path' )
----


====== Examples
Add MqTT broker connection and publish
[source,bash]
----
# --- Mosquitto MqTT client - start client ---
mosquitto_sub  --verbose --host localhost --port 1883 --topic mqtt/topic/# --id msqSub
----

[source,bash]
----
// --- register localhost mqtt broker viaNeo4j console ---
RETURN apoc.mqtt.addBroker(
 'mqttLocalhostBroker', 
 {
    serverURI:'tcp://localhost:1883',
    clientId:'neo4jClient01'
  }
)
----

[source,bash]
----
// --- publish messages ---
RETURN apoc.mqtt.publish(
    'mqttLocalhostBroker', 
    'mqtt/topic/json', 
    {
        string:"string",
        int:123,
        boolean:true
    }
)

RETURN apoc.mqtt.publish(
    'mqttLocalhostBroker', 
    'mqtt/topic/valueString', 
    "stringValue"
)

RETURN apoc.mqtt.publish(
    'mqttLocalhostBroker', 
    'mqtt/topic/valueInteger', 
    123
)
RETURN apoc.mqtt.publish(
    'mqttLocalhostBroker', 
    'mqtt/topic/valueNumber', 
    123.456
)

RETURN apoc.mqtt.publish(
    'mqttLocalhostBroker', 
    'mqtt/topic/valueBoolean', 
    true
)

CREATE (neo4jNode:TestMqttNode:TestNode {string:"string", int:123, boolean:true})
WITH neo4jNode
RETURN apoc.mqtt.publish(
    'mqttLocalhostBroker', 
    'mqtt/topic/neo4jNode', 
    neo4jNode
)

CREATE (s)-[r:TEST_MQTT_RELATION {string:"string", int:123, boolean:true}]->(e) 
WITH r AS neo4jRelation
RETURN apoc.mqtt.publish(
    'mqttLocalhostBroker', 
    'mqtt/topic/neo4jRelation', 
    neo4jRelation
)

----

[source,bash]
----
# --- Mosquitto MqTT client - check messages ---
mqtt/topic/json {"boolean":true,"string":"string","int":123}
mqtt/topic/valueString stringValue
mqtt/topic/valueInteger 123
mqtt/topic/valueNumber 123.456
mqtt/topic/valueBoolean true
mqtt/topic/neo4jNode {"id":80,"properties":{"boolean":true,"string":"string","int":123},"labels":"TestMqttNode:TestNode"}
mqtt/topic/neo4jRelation {"startNodeId":60,"id":8,"type":"TEST_MQTT_RELATION","endNodeId":61,"properties":{"boolean":true,"string":"string","int":123}}

----

[source,bash]
----


// succesful mqtt registration
{
  "mqttBrokerId": "mqttLocalhostBroker",
  "serverURI": "tcp://localhost:1883",
  "statusMessage": "Connect MqTT OK",
  "status": "ok"
}

// failed mqtt registrations
{
  "mqttBrokerId": "mqttLocalhostBroker",
  "serverURI": "tcp://localhost:1883",
  "statusMessage": "Broker with this name exists!",
  "status": "error"
}

{
  "mqttBrokerId": "mqttLocalhostBrokerError",
  "serverURI": "tcp://localhostNotExists:1883",
  "statusMessage": "Failed to Connect MqTT Broker: MqttException",
  "status": "error"
}
----

[source,bash]
----
// succesful mqtt publish
{
  "options": {

  },
  "mqttBrokerId": "mqttLocalhostBroker",
  "topic": "mqtt/topic/json",
  "message": {
    "string": "string",
    "int": 123,
    "boolean": true
  },
  "statusMessage": "MqTT Publish OK",
  "status": "ok"
}

// failed mqtt publish
{
  "options": {

  },
  "mqttBrokerId": "mqttLocalhostBrokerNotExist",
  "topic": "mqtt/topic/json",
  "message": {
    "string": "string",
    "int": 123,
    "boolean": true
  },
  "statusMessage": "Failed to find MqTT Broker - Check Connection",
  "status": "error"
}

----










Check Nodes created by Neo4j MqTT subsciber.
[source,cypher]
----

----

List MqTT broker connections.
[source,cypher]
----

----

Remove MqTT subscription.
[source,cypher]
----

----

[source,cypher]
----
 RETURN apoc.mqtt.delete('mqttBrokerId')
----

